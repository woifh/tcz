{% extends "base.html" %}

{% block title %}Meine Favoriten - Tennisclub{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/member-search.js') }}"></script>
{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Meine Favoriten</h2>
        <button onclick="showSearchForm()" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
            Favorit hinzufügen
        </button>
    </div>
    
    <p class="text-gray-600 mb-6">
        Fügen Sie Mitglieder zu Ihren Favoriten hinzu, um schnell Buchungen für sie zu erstellen.
    </p>
    
    <!-- Member Search Component -->
    <div id="member-search-container" class="hidden bg-gray-50 p-6 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-4">Mitglied suchen</h3>
        
        <!-- Search Input -->
        <div class="relative mb-4">
            <label for="member-search-input" class="sr-only">Mitglied suchen</label>
            <input 
                type="text" 
                id="member-search-input" 
                class="w-full border border-gray-300 rounded px-4 py-2 pr-20" 
                placeholder="Mitglied suchen..."
                aria-label="Mitglied suchen"
                aria-describedby="search-results-count"
                autocomplete="off"
            />
            <!-- Clear Button -->
            <button 
                id="search-clear-btn" 
                class="hidden absolute right-12 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                aria-label="Suche löschen"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <!-- Loading Spinner -->
            <div id="search-loading" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2">
                <svg class="animate-spin h-5 w-5 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
        
        <!-- Search Results Count (for screen readers) -->
        <div id="search-results-count" class="sr-only" aria-live="polite" aria-atomic="true"></div>
        
        <!-- Search Results Container -->
        <div id="search-results" class="space-y-2 max-h-96 overflow-y-auto" role="listbox" aria-label="Suchergebnisse"></div>
        
        <!-- Close Button -->
        <div class="mt-4">
            <button type="button" onclick="hideSearchForm()" class="bg-gray-300 text-gray-700 py-2 px-6 rounded hover:bg-gray-400">
                Schließen
            </button>
        </div>
    </div>
    
    <!-- Favourites List -->
    <div id="favourites-list" class="space-y-4">
        <p class="text-center text-gray-500 py-8">Lade Favoriten...</p>
    </div>
    
    <div class="mt-8">
        <a href="{{ url_for('dashboard.index') }}" class="text-green-600 hover:underline">← Zurück zur Übersicht</a>
    </div>
</div>

<script>
const currentUserId = {{ current_user.id }};
window.currentUserId = currentUserId; // Make available to member-search.js

// Load favourites on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFavourites();
});

async function loadFavourites() {
    try {
        const response = await fetch(`/members/${currentUserId}/favourites`);
        const data = await response.json();
        
        const listContainer = document.getElementById('favourites-list');
        
        if (response.ok && data.favourites && data.favourites.length > 0) {
            listContainer.innerHTML = data.favourites.map(fav => `
                <div class="flex justify-between items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                    <div>
                        <h3 class="font-semibold text-lg">${fav.name}</h3>
                        <p class="text-gray-600 text-sm">${fav.email}</p>
                    </div>
                    <button onclick="removeFavourite(${fav.id})" class="text-red-600 hover:text-red-900 font-semibold">
                        Entfernen
                    </button>
                </div>
            `).join('');
        } else {
            listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Keine Favoriten vorhanden. Fügen Sie Mitglieder hinzu, um schnell für sie zu buchen.</p>';
        }
    } catch (error) {
        console.error('Error loading favourites:', error);
        document.getElementById('favourites-list').innerHTML = '<p class="text-center text-red-500 py-8">Fehler beim Laden der Favoriten</p>';
    }
}

function showSearchForm() {
    const searchContainer = document.getElementById('member-search-container');
    searchContainer.classList.remove('hidden');
    
    // Initialize search functionality
    if (typeof window.initMemberSearch === 'function') {
        window.initMemberSearch();
    } else {
        console.error('initMemberSearch is not defined');
    }
}

function hideSearchForm() {
    const searchContainer = document.getElementById('member-search-container');
    searchContainer.classList.add('hidden');
    
    // Clear search input and results
    const searchInput = document.getElementById('member-search-input');
    searchInput.value = '';
    if (typeof window.clearSearchResults === 'function') {
        window.clearSearchResults();
    }
    
    // Hide clear button
    document.getElementById('search-clear-btn').classList.add('hidden');
}

async function removeFavourite(favouriteId) {
    if (!confirm('Möchten Sie diesen Favoriten wirklich entfernen?')) {
        return;
    }
    
    try {
        const response = await fetch(`/members/${currentUserId}/favourites/${favouriteId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Show success message as a toast notification
            showToast('Favorit erfolgreich entfernt', 'success');
            loadFavourites();
        } else {
            showToast('Fehler: ' + (data.error || 'Unbekannter Fehler'), 'error');
        }
    } catch (error) {
        showToast('Fehler beim Entfernen des Favoriten', 'error');
    }
}

function showToast(message, type = 'success') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
    }`;
    toast.textContent = message;
    
    // Add to page
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}

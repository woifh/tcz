{% extends "base.html" %}

{% block title %}Mitglieder - Tennisclub{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Mitglieder</h2>
        {% if current_user.is_admin() %}
        <button onclick="showNewMemberForm()" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
            Neues Mitglied
        </button>
        {% endif %}
    </div>
    
    <!-- New Member Form (Hidden by default) -->
    {% if current_user.is_admin() %}
    <div id="new-member-form" class="hidden bg-gray-50 p-6 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-4">Neues Mitglied erstellen</h3>
        <form id="create-member-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Vorname</label>
                <input type="text" id="new-member-firstname" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Nachname</label>
                <input type="text" id="new-member-lastname" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">E-Mail</label>
                <input type="email" id="new-member-email" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Passwort</label>
                <input type="password" id="new-member-password" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Rolle</label>
                <select id="new-member-role" class="w-full border border-gray-300 rounded px-3 py-2">
                    <option value="member">Mitglied</option>
                    <option value="teamster">Mannschaftsführer</option>
                    <option value="administrator">Administrator</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Mitgliedschaft</label>
                <select id="new-member-membership-type" class="w-full border border-gray-300 rounded px-3 py-2">
                    <option value="full">Vollmitglied</option>
                    <option value="sustaining">Fördermitglied</option>
                </select>
            </div>
            <div class="md:col-span-2 flex gap-4">
                <button type="submit" class="bg-green-600 text-white py-2 px-6 rounded hover:bg-green-700">
                    Erstellen
                </button>
                <button type="button" onclick="hideNewMemberForm()" class="bg-gray-300 text-gray-700 py-2 px-6 rounded hover:bg-gray-400">
                    Abbrechen
                </button>
            </div>
        </form>
    </div>

    <!-- Edit Member Form (Hidden by default) -->
    <div id="edit-member-form" class="hidden bg-gray-50 p-6 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-4">Mitglied bearbeiten</h3>
        <form id="update-member-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="hidden" id="edit-member-id">
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Vorname</label>
                <input type="text" id="edit-member-firstname" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Nachname</label>
                <input type="text" id="edit-member-lastname" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">E-Mail</label>
                <input type="email" id="edit-member-email" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Neues Passwort (optional)</label>
                <input type="password" id="edit-member-password" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Leer lassen, um beizubehalten">
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Rolle</label>
                <select id="edit-member-role" class="w-full border border-gray-300 rounded px-3 py-2">
                    <option value="member">Mitglied</option>
                    <option value="teamster">Mannschaftsführer</option>
                    <option value="administrator">Administrator</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Mitgliedschaft</label>
                <select id="edit-member-membership-type" class="w-full border border-gray-300 rounded px-3 py-2">
                    <option value="full">Vollmitglied</option>
                    <option value="sustaining">Fördermitglied</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Beitrag</label>
                <div class="flex items-center gap-4 mt-2">
                    <label class="flex items-center">
                        <input type="radio" name="member-fee-paid" value="true" id="edit-member-fee-paid" class="mr-2">
                        <span class="text-sm text-green-600">Bezahlt</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="member-fee-paid" value="false" id="edit-member-fee-unpaid" class="mr-2">
                        <span class="text-sm text-red-600">Offen</span>
                    </label>
                </div>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Status</label>
                <div class="flex items-center gap-4 mt-2">
                    <label class="flex items-center">
                        <input type="radio" name="member-status" value="active" id="edit-member-active" class="mr-2">
                        <span class="text-sm">Aktiv</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="member-status" value="inactive" id="edit-member-inactive" class="mr-2">
                        <span class="text-sm">Deaktiviert</span>
                    </label>
                </div>
            </div>
            <div class="md:col-span-2 flex gap-4">
                <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700">
                    Aktualisieren
                </button>
                <button type="button" onclick="hideEditMemberForm()" class="bg-gray-300 text-gray-700 py-2 px-6 rounded hover:bg-gray-400">
                    Abbrechen
                </button>
            </div>
        </form>
    </div>
    {% endif %}
    
    <div class="mb-4">
        <div class="relative flex-1 sm:flex-initial">
            <input
                type="text"
                id="member-filter"
                placeholder="Mitglieder durchsuchen..."
                class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent focus:outline-none"
                aria-label="Mitglieder durchsuchen"
            >
            <span class="material-icons absolute left-3 top-2.5 text-gray-400 text-sm pointer-events-none">search</span>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table id="members-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="name">
                        <span class="flex items-center gap-1">Name <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="email">
                        <span class="flex items-center gap-1">E-Mail <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="role">
                        <span class="flex items-center gap-1">Rolle <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="membership">
                        <span class="flex items-center gap-1">Mitgliedschaft <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="payment">
                        <span class="flex items-center gap-1">Beitrag <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="bookings">
                        <span class="flex items-center gap-1">Buchungen <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="created">
                        <span class="flex items-center gap-1">Erstellt am <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    {% if current_user.is_admin() %}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktionen</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for member in members %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">{{ member.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ member.email }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="{% if member.role == 'administrator' %}text-yellow-600{% elif member.role == 'teamster' %}text-blue-600{% else %}text-gray-600{% endif %}">
                            {{ 'Administrator' if member.role == 'administrator' else 'Mannschaftsführer' if member.role == 'teamster' else 'Mitglied' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="{% if member.membership_type == 'full' %}text-green-600{% else %}text-blue-600{% endif %}">
                            {{ 'Vollmitglied' if member.membership_type == 'full' else 'Fördermitglied' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if member.fee_paid %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <span class="material-icons text-xs mr-1">check_circle</span>
                            Bezahlt
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            <span class="material-icons text-xs mr-1">warning</span>
                            Offen
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">
                            <div class="text-gray-500">{{ member.total_booking_count|default(0) }} Buchungen</div>
                            <div class="text-gray-500">{{ member.short_notice_count|default(0) }} Kurzfristig</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">
                        {{ member.created_at.strftime('%d.%m.%Y') }}
                    </td>
                    {% if current_user.is_admin() %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="editMember({{ member.id }})" class="text-blue-600 hover:text-blue-900 p-1" title="Bearbeiten">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        {% if member.id != current_user.id %}
                        <button onclick="deleteMember({{ member.id }})" class="text-red-600 hover:text-red-900 p-1 ml-2" title="Löschen">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
</div>

<script>
function showNewMemberForm() {
    hideEditMemberForm(); // Hide edit form if open
    document.getElementById('new-member-form').classList.remove('hidden');
}

function hideNewMemberForm() {
    document.getElementById('new-member-form').classList.add('hidden');
    document.getElementById('create-member-form').reset();
}

function showEditMemberForm() {
    hideNewMemberForm(); // Hide create form if open
    document.getElementById('edit-member-form').classList.remove('hidden');
    // Scroll to the form
    document.getElementById('edit-member-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hideEditMemberForm() {
    document.getElementById('edit-member-form').classList.add('hidden');
    document.getElementById('update-member-form').reset();
}

document.getElementById('create-member-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const memberData = {
        firstname: document.getElementById('new-member-firstname').value,
        lastname: document.getElementById('new-member-lastname').value,
        email: document.getElementById('new-member-email').value,
        password: document.getElementById('new-member-password').value,
        role: document.getElementById('new-member-role').value,
        membership_type: document.getElementById('new-member-membership-type').value
    };

    try {
        const response = await fetch('/members/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(memberData)
        });

        const data = await response.json();

        if (response.ok) {
            showToast('Mitglied erfolgreich erstellt!');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(data.error || 'Unbekannter Fehler', 'error');
        }
    } catch (error) {
        showToast('Fehler beim Erstellen des Mitglieds', 'error');
    }
});

document.getElementById('update-member-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const memberId = document.getElementById('edit-member-id').value;
    const currentStatus = document.querySelector('input[name="member-status"]:checked').value;
    const wasActive = document.getElementById('edit-member-form').dataset.wasActive === 'true';

    const memberData = {
        firstname: document.getElementById('edit-member-firstname').value,
        lastname: document.getElementById('edit-member-lastname').value,
        email: document.getElementById('edit-member-email').value,
        role: document.getElementById('edit-member-role').value,
        membership_type: document.getElementById('edit-member-membership-type').value,
        fee_paid: document.querySelector('input[name="member-fee-paid"]:checked').value
    };

    // Only include password if provided
    const password = document.getElementById('edit-member-password').value;
    if (password) {
        memberData.password = password;
    }

    try {
        // First update the member data
        const response = await fetch(`/members/${memberId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(memberData)
        });

        const data = await response.json();

        if (!response.ok) {
            showToast(data.error || 'Fehler beim Aktualisieren', 'error');
            return;
        }

        // Handle status change (activate/deactivate) if needed
        if (currentStatus === 'inactive' && wasActive) {
            // Deactivate the member
            const deactivateResponse = await fetch(`/members/${memberId}/deactivate`, {
                method: 'POST'
            });

            if (!deactivateResponse.ok) {
                const deactivateData = await deactivateResponse.json();
                showToast(deactivateData.error || 'Fehler beim Deaktivieren', 'error');
                return;
            }
        } else if (currentStatus === 'active' && !wasActive) {
            // Reactivate the member
            const reactivateResponse = await fetch(`/members/${memberId}/reactivate`, {
                method: 'POST'
            });

            if (!reactivateResponse.ok) {
                const reactivateData = await reactivateResponse.json();
                showToast(reactivateData.error || 'Fehler beim Reaktivieren', 'error');
                return;
            }
        }

        showToast('Mitglied erfolgreich aktualisiert!');
        setTimeout(() => window.location.reload(), 500);

    } catch (error) {
        showToast('Fehler beim Aktualisieren des Mitglieds', 'error');
    }
});

async function editMember(memberId) {
    try {
        // Fetch member details
        const response = await fetch(`/members/${memberId}`);
        const data = await response.json();

        if (!response.ok) {
            showToast(data.error || 'Fehler beim Laden der Mitgliedsdaten', 'error');
            return;
        }

        // Populate the form
        document.getElementById('edit-member-id').value = data.id;
        document.getElementById('edit-member-firstname').value = data.firstname;
        document.getElementById('edit-member-lastname').value = data.lastname;
        document.getElementById('edit-member-email').value = data.email;
        document.getElementById('edit-member-role').value = data.role;
        document.getElementById('edit-member-password').value = '';

        // Set membership type
        document.getElementById('edit-member-membership-type').value = data.membership_type || 'full';

        // Set fee paid radio buttons
        if (data.fee_paid) {
            document.getElementById('edit-member-fee-paid').checked = true;
        } else {
            document.getElementById('edit-member-fee-unpaid').checked = true;
        }

        // Set status radio buttons
        if (data.is_active) {
            document.getElementById('edit-member-active').checked = true;
        } else {
            document.getElementById('edit-member-inactive').checked = true;
        }

        // Store original active status for comparison
        document.getElementById('edit-member-form').dataset.wasActive = data.is_active;

        // Show the edit form
        showEditMemberForm();

    } catch (error) {
        showToast('Fehler beim Laden der Mitgliedsdaten', 'error');
    }
}

async function deleteMember(memberId) {
    if (!confirm('Möchten Sie dieses Mitglied wirklich löschen?')) {
        return;
    }

    try {
        const response = await fetch(`/members/${memberId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
            showToast('Mitglied erfolgreich gelöscht!');
            setTimeout(() => window.location.reload(), 500);
        } else {
            // If deletion failed due to active reservations, ask if they want to force delete
            if (data.error && data.error.includes('aktive Buchungen')) {
                if (confirm(data.error + '\n\nMöchten Sie das Mitglied trotzdem löschen? Alle Buchungen werden storniert.')) {
                    // Force delete
                    const forceResponse = await fetch(`/members/${memberId}?force=true`, {
                        method: 'DELETE'
                    });
                    const forceData = await forceResponse.json();

                    if (forceResponse.ok) {
                        showToast('Mitglied und alle Buchungen erfolgreich gelöscht!');
                        setTimeout(() => window.location.reload(), 500);
                    } else {
                        showToast(forceData.error || 'Unbekannter Fehler', 'error');
                    }
                }
            } else {
                showToast(data.error || 'Unbekannter Fehler', 'error');
            }
        }
    } catch (error) {
        showToast('Fehler beim Löschen des Mitglieds', 'error');
    }
}

// Quick filter functionality
(function() {
    const filterInput = document.getElementById('member-filter');
    const table = document.getElementById('members-table');
    if (!filterInput || !table) return;

    filterInput.addEventListener('input', () => {
        const filter = filterInput.value.toLowerCase().trim();
        const rows = table.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const name = row.cells[0]?.textContent.toLowerCase() || '';
            const email = row.cells[1]?.textContent.toLowerCase() || '';
            const matches = name.includes(filter) || email.includes(filter);
            row.style.display = matches ? '' : 'none';
        });
    });
})();

// Table sorting functionality
(function() {
    const table = document.getElementById('members-table');
    if (!table) return;

    const headers = table.querySelectorAll('th[data-sort]');
    let currentSort = { column: null, direction: 'asc' };

    // SVG paths for different states
    const defaultIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>';
    const ascIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>';
    const descIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>';

    headers.forEach(header => {
        header.addEventListener('click', () => {
            const column = header.dataset.sort;
            const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';

            sortTable(column, direction);
            currentSort = { column, direction };

            // Update sort icons
            headers.forEach(h => {
                const icon = h.querySelector('.sort-icon');
                if (h === header) {
                    icon.innerHTML = direction === 'asc' ? ascIcon : descIcon;
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-gray-700');
                } else {
                    icon.innerHTML = defaultIcon;
                    icon.classList.remove('text-gray-700');
                    icon.classList.add('text-gray-400');
                }
            });
        });
    });

    function sortTable(column, direction) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        const columnIndex = {
            'name': 0,
            'email': 1,
            'role': 2,
            'membership': 3,
            'payment': 4,
            'bookings': 5,
            'created': 6
        }[column];

        rows.sort((a, b) => {
            let aVal = a.cells[columnIndex]?.textContent.trim() || '';
            let bVal = b.cells[columnIndex]?.textContent.trim() || '';

            // Handle date sorting (DD.MM.YYYY format)
            if (column === 'created') {
                const parseDate = (str) => {
                    const parts = str.split('.');
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                };
                aVal = parseDate(aVal);
                bVal = parseDate(bVal);
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Handle numeric sorting for bookings (extract number from "X Buchungen")
            if (column === 'bookings') {
                aVal = parseInt(aVal.match(/\d+/)?.[0]) || 0;
                bVal = parseInt(bVal.match(/\d+/)?.[0]) || 0;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Handle role sorting (by priority: administrator > teamster > member)
            if (column === 'role') {
                const rolePriority = { 'Administrator': 3, 'Mannschaftsführer': 2, 'Mitglied': 1 };
                aVal = rolePriority[aVal] || 0;
                bVal = rolePriority[bVal] || 0;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Handle membership sorting (Vollmitglied > Fördermitglied)
            if (column === 'membership') {
                const membershipPriority = { 'Vollmitglied': 2, 'Fördermitglied': 1 };
                aVal = membershipPriority[aVal] || 0;
                bVal = membershipPriority[bVal] || 0;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Handle payment sorting (Bezahlt > Offen)
            if (column === 'payment') {
                const paymentPriority = { 'Bezahlt': 2, 'Offen': 1 };
                aVal = paymentPriority[aVal] || 0;
                bVal = paymentPriority[bVal] || 0;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Default string sorting
            return direction === 'asc'
                ? aVal.localeCompare(bVal, 'de')
                : bVal.localeCompare(aVal, 'de');
        });

        rows.forEach(row => tbody.appendChild(row));
    }
})();
</script>
{% endblock %}
